<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>GraphQL Partial Update Â· Igor Kostyuchenok</title><meta name="description" content="GraphQL Partial Update - Igor Kostyuchenok"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://igorkosta.github.io/atom.xml" title="Igor Kostyuchenok"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Igor Kostyuchenok" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/services/" target="_self" class="nav-list-link">SERVICES</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://t.me/FinTechNewz" target="_blank" class="nav-list-link">FINTECHNEWZ</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">GraphQL Partial Update</h1><div class="post-info">Apr 13, 2021</div><div class="post-content"><p>Recently we decided to use <a target="_blank" rel="noopener" href="https://aws.amazon.com/amplify">AWS Amplify</a> for one of the products weâ€™re currently working on.</p>
<p><a target="_blank" rel="noopener" href="https://aws.amazon.com/amplify">AWS Amplify</a> promises to provide you with the option to rapidly develop the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Representational_state_transfer">REST</a> or a <a target="_blank" rel="noopener" href="https://graphql.org/">GraphQL</a> based backend thatâ€™s very well integrated with your frontend development - be it a web application or a mobile app. Thatâ€™s at least the marketed value proposition.</p>
<span id="more"></span>

<p>I donâ€™t wanna say thatâ€™s <a target="_blank" rel="noopener" href="https://aws.amazon.com/amplify">AWS Amplify</a> is still in its infancy but letâ€™s say itâ€™s<br>not without its caveats. One of them is the documentation. In general AWS<br>provides a lot of documentation, which doesnâ€™t necessarily means that itâ€™s<br>good.</p>
<p>Usually the truly technical documentation like the one for AWS SDK is really<br>good, which is not always the case with the Docs for other services. With AWS<br>Amplify itâ€™s pretty often the case that the documentation is not up-to-date and<br>you have to dig through the GitHub tickets discussions to find the truth or<br>the undocumented features (yes, <code>@http resolvers</code> - I look at you)</p>
<p>If you have to provide custom headers to your HTTP resolver based GraphQL<br>operation - you can send them as part of <code>API.graphql()</code> call as last<br>parameter, e.g.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> headers = &#123;</span><br><span class="line">  <span class="attr">foor</span>: <span class="string">&#x27;bar&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> response = <span class="keyword">await</span> API.graphql(</span><br><span class="line">  graphqlOperation(createFooBar, &#123; body &#125;),</span><br><span class="line">  headers,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>But Iâ€™m drifting away ðŸ˜€</p>
<p>Ok, so, we decided to go with GraphQL since in the final iterations the product should have more than just a web application and, theoretically, it should be easier to fetch only the data you need due to the flexible nature of <a target="_blank" rel="noopener" href="https://graphql.org/">GraphQL</a>.</p>
<p>So, if you worked with <a target="_blank" rel="noopener" href="https://aws.amazon.com/amplify/">AWS Amplify</a> and <a target="_blank" rel="noopener" href="https://graphql.org/">GraphQL</a> you know that it doesnâ€™t support partial updates, which was a deal-breaker for us, since we have multiple flows where we have to partially push the data to the backend.</p>
<p>After a short research online, I found a pretty cool article from <a target="_blank" rel="noopener" href="https://medium.com/@arnaud.bezancon">Arnaud BezanÃ§on</a> here <a target="_blank" rel="noopener" href="https://medium.com/workflowgen/graphql-mutations-partial-updates-implementation-bff586bda989">https://medium.com/workflowgen/graphql-mutations-partial-updates-implementation-bff586bda989</a></p>
<p>Although I really liked his way of doing things, my lazy nature wanted to have a more generic (not necessarily a better) solution though. So, my way of thinking was: since I only send parts of the data to the backend but it expects the whole { input } object from me, I will just merge the existing data with the new one and push it to the backend.</p>
<p>What you have to consider as well is that you will have to remove any automatically generated/updated fields from your <code>json</code> object â€” in my case <code>createdAt/updatedAt</code> fields.</p>
<p>So, below you see a quick and dirty way of doing it.</p>
<p>Please, note that Iâ€™m using email as the key of our user model. In addition to that, you will have to always send the whole user object with all the fields to the update mutation â€” meaning when you call <code>getUser</code> it should fetch the user object with all the fields.</p>
<p>In a nutshell - the flow is the following:</p>
<ul>
<li>try to fetch the user from the backend</li>
<li>if the user doesnâ€™t exist - call <code>createUser</code> with the provided data</li>
<li>if the user exist - merge the existing data with the new one and call<br><code>updateUser</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; API, graphqlOperation &#125; <span class="keyword">from</span> <span class="string">&#x27;aws-amplify&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getUser &#125; <span class="keyword">from</span> <span class="string">&#x27;@/graphql/queries&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createUser, updateUser &#125; <span class="keyword">from</span> <span class="string">&#x27;@/graphql/mutations&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; exclude &#125; <span class="keyword">from</span> <span class="string">&#x27;@/utils/json&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> get = <span class="keyword">async</span> (email) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">getUser</span>: user,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125; = <span class="keyword">await</span> API.graphql(graphqlOperation(getUser, &#123; email &#125;));</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(error.errors);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createOrUpdate = <span class="keyword">async</span> (input) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; email &#125; = input;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> get(email);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      <span class="keyword">await</span> API.graphql(graphqlOperation(createUser, &#123; input &#125;));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// get current user data</span></span><br><span class="line">      <span class="comment">// and only update the provided values</span></span><br><span class="line">      <span class="comment">// createdAt, updatedAt have to be excluded</span></span><br><span class="line">      <span class="keyword">const</span> update = &#123; ...exclude([<span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;updatedAt&#x27;</span>], user), ...input &#125;;</span><br><span class="line">      <span class="keyword">await</span> API.graphql(graphqlOperation(updateUser, &#123; <span class="attr">input</span>: update &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(error.errors);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  get,</span><br><span class="line">  createOrUpdate,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Since the email is used as the key of the user model, it has to be passed to the <code>createOrUpdate</code> function as part of the <code>&#123; input &#125;</code> object. Whenever I have to create or update a user, we have to add the email to the input and then just call <code>createOrUpdate(input);</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; email &#125; = user;</span><br><span class="line"><span class="keyword">const</span> input = &#123; email, â€¦payload &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">await</span> createOrUpdate(input);</span><br><span class="line">  ...</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Itâ€™s not an efficient way of doing things since it will fetch the data from your backend before doing an update but this way you donâ€™t have to do things manually or thing about the values youâ€™d like to be updated.</p>
<p>Thatâ€™s all folks.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2021/09/27/perfect-startup-team/" class="prev">PREV</a><a href="/2021/04/10/mock-promisified-aws-sdk-calls/" class="next">NEXT</a></div><div class="copyright"><p>Â© 2021 <a href="https://igorkosta.github.io">Igor Kostyuchenok</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-42619461-1",'auto');ga('send','pageview');</script></body></html>